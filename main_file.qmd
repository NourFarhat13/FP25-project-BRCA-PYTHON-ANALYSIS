---
title: "Breast Cancer Survival Analysis"
author: "Nour Farhat"
format:
  html:
    code-fold: true
---

## 1. Introduction

This report analyses a breast cancer dataset from The Cancer Genome Atlas (TCGA).
The data contains clinical information and protein expression levels
for 334 patients (321 after cleaning).

**Research question:**
Which clinical and biomarker factors are associated with patient survival
(Alive vs Dead) in breast cancer patients?

**Sub-questions:**

1. How does tumour stage relate to survival rate?
2. Do protein expression levels differ between survivors and non-survivors?
3. Does surgery type influence patient outcomes?

| Type        | Columns                                                       |
|-------------|---------------------------------------------------------------|
| Numeric     | age, protein1, protein2, protein3, protein4                   |
| Categorical | gender, tumour_stage, histology, er/pr/her2 status, surgery_type |
| Target      | patient_status (Alive / Dead)                                 |

## 2. Data Loading

We load the pre-processed dataset (`data_full.csv`, produced by `process_data.py`)
and import our analysis functions from `functions.py`.

```{python}
#| label: load-data

import pandas as pd
from functions import (
    validate_dataframe,
    helper,
    analyze,
    visualize_survival_by,
    visualize_proteins,
    visualize_age,
    run_kmeans,
)

# Load cleaned dataset (relative path)
brca = pd.read_csv("data_full.csv")
print(f"Dataset: {brca.shape[0]} rows, {brca.shape[1]} columns")
```

## 3. Data Overview

```{python}
#| label: data-types

print(brca.dtypes)
```

```{python}
#| label: data-head

brca.head()
```

```{python}
#| label: data-missing

missing = brca.isnull().sum()
missing[missing > 0]
```

The only remaining missing values are in `date_of_last_visit`.
We kept these as NaN because imputing dates would be misleading --
these patients simply lack follow-up data.

## 4. Exploratory Data Analysis

### 4.1 Descriptive Statistics by Survival Status

```{python}
#| label: desc-stats

summary = analyze(brca, group_col="patient_status")
summary
```

The group means are very similar: mean age is ~59 for both groups
and protein levels differ only in the second decimal place. None of these
numeric variables alone will strongly separate the two groups.

### 4.2 Survival by Tumour Stage

```{python}
#| label: fig-tumour-stage

visualize_survival_by(brca, "tumour_stage")
```

There is a mild upward trend in death rate with increasing tumour stage.
However, the differences are modest and the small sample sizes per stage
limit what we can conclude.

### 4.3 Survival by Surgery Type

```{python}
#| label: fig-surgery-type

visualize_survival_by(brca, "surgery_type")
```

Surgery types show some variation in death proportions, but this does not
imply causation -- patients receiving different surgeries likely differ
in tumour severity.

### 4.4 Protein Expression Levels by Survival

```{python}
#| label: fig-proteins

visualize_proteins(brca)
```

The boxplots show substantial overlap between Alive and Dead patients
across all four proteins, indicating no strong differentiation.

### 4.5 Age Distribution by Survival

```{python}
#| label: fig-age

visualize_age(brca)
```

The age distributions are nearly identical for both groups.
Age does not appear to be a distinguishing factor for survival.

## 5. Feature Engineering

For K-Means clustering we prepare and scale our numeric features so that
no single variable dominates the distance calculation.

- **Features used:** age, protein1--protein4.
- **Scaling:** `StandardScaler` centres each feature at mean 0 and scales
  to unit variance (important because age ~29--90 vs proteins ~-2 to 3).
- Categorical variables are excluded because K-Means uses Euclidean distance.

```{python}
#| label: feature-scaling
#| output: hold

from sklearn.preprocessing import StandardScaler
import matplotlib.pyplot as plt
import seaborn as sns

feature_cols = ["age", "protein1", "protein2", "protein3", "protein4"]
brca_cluster = brca[feature_cols].dropna().copy()

scaler = StandardScaler()
scaled_values = scaler.fit_transform(brca_cluster)
brca_scaled = pd.DataFrame(scaled_values, columns=feature_cols, index=brca_cluster.index)

print(f"Prepared {len(brca_scaled)} patients with {len(feature_cols)} scaled features")
print(f"\nScaled feature summary (should be ~mean 0, std 1):")
print(brca_scaled.describe().loc[["mean", "std"]].round(2))
```

## 6. Simple Machine Learning Extension -- K-Means Clustering

This section is secondary to the EDA above.
We use K-Means to explore whether patients naturally group into distinct
profiles based on protein expression and age.
K-Means is unsupervised -- it finds groups without knowing survival labels.

### 6.1 Running K-Means

```{python}
#| label: kmeans-fit

labels, kmeans_model = run_kmeans(brca_scaled, n_clusters=2)

brca_scaled["cluster"] = labels
brca_scaled["patient_status"] = brca.loc[brca_scaled.index, "patient_status"].values

print(f"Cluster sizes:\n{brca_scaled['cluster'].value_counts().sort_index()}")
```

### 6.2 Clusters vs Actual Survival

We plot protein1 vs protein2, colouring by cluster (left) and actual
survival status (right).

```{python}
#| label: fig-clusters-scatter

fig, axes = plt.subplots(1, 2, figsize=(14, 5))

# Left: coloured by cluster
for cluster_id in sorted(brca_scaled["cluster"].unique()):
    mask = brca_scaled["cluster"] == cluster_id
    axes[0].scatter(
        brca_scaled.loc[mask, "protein1"],
        brca_scaled.loc[mask, "protein2"],
        label=f"Cluster {cluster_id}",
        alpha=0.6, s=40,
    )

centroids = kmeans_model.cluster_centers_
axes[0].scatter(
    centroids[:, 1], centroids[:, 2],
    marker="X", s=200, c="black", label="Centroids",
)
axes[0].set_xlabel("Protein1 (scaled)")
axes[0].set_ylabel("Protein2 (scaled)")
axes[0].set_title("K-Means Clusters")
axes[0].legend()

# Right: coloured by actual survival status
for status in sorted(brca_scaled["patient_status"].unique()):
    mask = brca_scaled["patient_status"] == status
    axes[1].scatter(
        brca_scaled.loc[mask, "protein1"],
        brca_scaled.loc[mask, "protein2"],
        label=status,
        alpha=0.6, s=40,
    )
axes[1].set_xlabel("Protein1 (scaled)")
axes[1].set_ylabel("Protein2 (scaled)")
axes[1].set_title("Actual Survival Status")
axes[1].legend()

plt.tight_layout()
plt.show()
```

Comparing the two panels reveals that the clusters **do not** align
with actual survival status.

### 6.3 Cluster vs Survival -- Cross-Tabulation

```{python}
#| label: cluster-survival
#| output: hold

crosstab = pd.crosstab(
    brca_scaled["cluster"],
    brca_scaled["patient_status"],
    margins=True,
)
print("Cluster vs Actual Survival Status:")
print(crosstab)

print("\nDeath rate per cluster:")
for cluster_id in sorted(brca_scaled["cluster"].unique()):
    mask = brca_scaled["cluster"] == cluster_id
    n_total = mask.sum()
    n_dead = (brca_scaled.loc[mask, "patient_status"] == "Dead").sum()
    rate = round(n_dead / n_total * 100, 1)
    print(f"  Cluster {cluster_id}: {n_dead}/{n_total} = {rate}% Dead")

n_dead_all = (brca_scaled["patient_status"] == "Dead").sum()
n_total_all = len(brca_scaled)
overall_rate = round(n_dead_all / n_total_all * 100, 1)
print(f"  Overall:    {n_dead_all}/{n_total_all} = {overall_rate}% Dead")
```

Death rates are nearly identical across both clusters (~20%), confirming
the clusters do not separate survivors from non-survivors. K-Means grouped
patients by protein expression patterns -- but those patterns are unrelated
to survival, suggesting it depends on factors beyond these numeric variables.

## 7. Limitations

- **Small sample size** (321 patients) limits statistical power.
- **Observational data** -- no causal claims possible.
- **K-Means assumes spherical clusters** which may not reflect the true structure.
- **Choice of k=2** -- the optimal number of clusters may differ.
- **Only numeric features** -- categorical variables were excluded from clustering.

## 8. Conclusion

1. **Tumour stage:** Mild upward trend in death rate from Stage I to III,
   but differences are modest. Weak association with survival.
2. **Protein expression:** Similar levels between Alive and Dead patients.
   Boxplots showed substantial overlap -- no strong association.
3. **Surgery type:** Some variation in death proportions, but likely reflects
   differences in patient severity rather than a causal effect.

K-Means clustering confirmed these findings: unsupervised grouping did not
separate survivors from non-survivors, reinforcing that survival depends on
factors beyond the numeric variables in this dataset.
